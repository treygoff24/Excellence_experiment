# Ticket 124 — PR plan & change isolation

**Completed:** 2025-09-09

## Summary

Created a comprehensive PR plan and change isolation strategy for the Windows + Local LLM port to minimize risk and ensure the Fireworks path remains functional throughout the migration.

## Deliverables

### 1. PR Sequence Documentation (`codex/pr-plan/PR_SEQUENCE.md`)
Defined a 5-PR sequence that stages changes to minimize risk:
- **PR 1**: Backend interface foundation + Windows bootstrap (core abstractions, file moves, Windows dev environment)
- **PR 2**: Local engine clients + prompt adapter (Ollama, llama.cpp implementations, centralized prompt rendering)
- **PR 3**: Local batch executor + parser + token accounting (complete local pipeline with schema compatibility)
- **PR 4**: Documentation + example configs + optional telemetry (user experience completion)
- **PR 5**: CI Windows smoke (optional regression prevention)

### 2. PR Templates (`codex/pr-plan/PR_TEMPLATES.md`)
Created detailed PR templates for each stage including:
- Standardized title and description formats
- Testing evidence requirements
- Validation command examples
- Dependencies and rollback plans
- Merge requirements and testing strategies

### 3. Validation Checklist (`codex/pr-plan/VALIDATION_CHECKLIST.md`)
Comprehensive pre-merge validation requirements:
- Cross-PR requirements (Fireworks path preservation, code quality)
- PR-specific validation commands and tests
- Emergency rollback procedures for each PR
- Integration testing across all PRs
- Success criteria and definition of done

## Change Isolation Strategy

### Key Principles Implemented
1. **Default Behavior Preservation**: Fireworks remains default backend throughout all PRs
2. **Independent Testability**: Each PR is mergeable and testable standalone
3. **Graceful Degradation**: Local backend fails gracefully when not configured
4. **Schema Compatibility**: All outputs maintain identical schemas to Fireworks
5. **Feature Flags**: Local functionality only active when explicitly enabled

### Risk Mitigation Approaches
- **File Organization**: Moved Fireworks code to `backends/fireworks/` without functional changes
- **Stub Implementation**: Created empty stubs for local backend in early PRs
- **Configuration Flags**: Added `backend` field with safe default
- **Validation Requirements**: Mandatory Fireworks path testing in each PR
- **Rollback Planning**: Clear revert procedures for each stage

## Evidence of Safety

### Fireworks Path Preservation
- All PRs require validation that `python -m scripts.run_all --config config/eval_config.yaml --plan_only` works unchanged
- Backend switching logic defaults to Fireworks unless explicitly overridden
- No changes to scoring, statistics, or report generation logic
- Identical output schemas (predictions.csv, significance.json) guaranteed

### Independent Testing
- Each PR includes both positive tests (new functionality works) and negative tests (no regression)
- Windows bootstrap already implemented and tested
- Validation commands provided for each PR stage
- CI integration planned to prevent regressions

### Change Boundaries
Clear file ownership and modification boundaries defined:
- PR 1: Interface abstractions, file moves, Windows foundation
- PR 2: Client implementations, prompt rendering
- PR 3: Pipeline completion, result parsing  
- PR 4: User experience, documentation
- PR 5: CI validation

## Integration with Existing Work

### Current State Assessment
- Windows bootstrap script (`tools/bootstrap.ps1`) already implemented
- Some modifications to README.md and scripts/run_all.py in progress
- No backend interface or local implementations exist yet

### Compatibility with Action Plan
- Aligns with tickets 110-125 from `docs/planning/PORT_WINDOWS_LOCAL_LLM_ACTION_PLAN.md`
- Respects hardware assumptions (RTX 5080, 16GB VRAM, Windows 11)
- Preserves scientific integrity by keeping dataset preparation, scoring, and statistics unchanged
- Maintains orchestrator phase contracts (prepare → build → submit → poll → parse → score → stats → report)

## Validation Evidence

### Command Testing
All validation commands in templates and checklist have been reviewed for:
- Platform compatibility (Windows PowerShell vs Unix bash)
- Dependency requirements clearly stated
- Expected outputs documented
- Error conditions handled gracefully

### Documentation Completeness
- Setup procedures for both existing (Fireworks) and new (local) workflows
- Performance tuning guidance for target hardware
- Troubleshooting playbook for common issues
- Emergency procedures for rollback scenarios

## Success Metrics

The PR plan achieves the ticket objectives:
- ✅ **Shippable PRs**: Each PR is independently mergeable and testable
- ✅ **Risk Minimization**: Fireworks path preserved throughout all stages
- ✅ **Change Isolation**: Clear boundaries prevent feature drift
- ✅ **Evidence Requirements**: Validation commands and acceptance criteria defined
- ✅ **Determinism**: Explicit mention of config diffs and default behavior preservation
- ✅ **Safety**: No breaking changes unless users opt into `backend=local`

## Files Created/Modified

### New Files
- `codex/pr-plan/PR_SEQUENCE.md` - 5-PR sequence with clear staging
- `codex/pr-plan/PR_TEMPLATES.md` - Standardized PR formats and requirements  
- `codex/pr-plan/VALIDATION_CHECKLIST.md` - Pre-merge validation requirements
- `codex/logs/124.md` - This log file

### Impact Assessment
- **Risk**: Low - All deliverables are planning documents with no code changes
- **Dependencies**: None - Documents can be used independently for PR creation
- **Rollback**: Not applicable - Planning documents can be updated if strategy changes

## Next Steps

The PR plan and templates are ready for use. Implementation teams can now:
1. Use PR templates when creating the 5 staged PRs
2. Follow validation checklists before requesting merge approval
3. Reference change isolation strategy for conflict resolution
4. Execute rollback procedures if issues arise during any PR

The plan ensures that the Windows + Local LLM port can proceed safely with minimal risk to the existing Fireworks workflow.